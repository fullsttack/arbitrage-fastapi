<!-- Enhanced Dashboard Template - save as templates/admin/enhanced_index.html -->
{% extends "admin/index.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Header -->
    <div class="dashboard-header">
        <h1 class="text-gradient">{% trans "Crypto Arbitrage Dashboard" %}</h1>
        <p class="dashboard-subtitle">{% trans "Real-time monitoring and analytics for your arbitrage operations" %}</p>
    </div>

    <!-- Quick Stats Grid -->
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-label">{% trans "Active Opportunities" %}</div>
            <div class="quick-stat-value" id="active-opportunities">{{ active_opportunities|default:"0" }}</div>
            <div class="quick-stat-change">
                <span class="profit-positive">+{{ todays_opportunities|default:"0" }}</span> {% trans "today" %}
            </div>
        </div>
        
        <div class="quick-stat">
            <div class="quick-stat-label">{% trans "Weekly Profit" %}</div>
            <div class="quick-stat-value profit-positive" id="weekly-profit">${{ weekly_profit|floatformat:2|default:"0.00" }}</div>
            <div class="quick-stat-change">
                <span class="profit-positive">{{ success_rate|floatformat:1|default:"0.0" }}%</span> {% trans "success rate" %}
            </div>
        </div>
        
        <div class="quick-stat">
            <div class="quick-stat-label">{% trans "Exchange Health" %}</div>
            <div class="quick-stat-value">{{ online_exchanges|default:"0" }}/{{ total_exchanges|default:"0" }}</div>
            <div class="quick-stat-change">
                <span class="status-online">{{ avg_response_time|floatformat:0|default:"0" }}ms</span> {% trans "avg response" %}
            </div>
        </div>
        
        <div class="quick-stat">
            <div class="quick-stat-label">{% trans "Active Orders" %}</div>
            <div class="quick-stat-value" id="active-orders">{{ active_orders|default:"0" }}</div>
            <div class="quick-stat-change">
                <span class="status-online">{{ todays_trades|default:"0" }}</span> {% trans "trades today" %}
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Arbitrage Opportunities Card -->
        <div class="dashboard-card card-primary">
            <div class="dashboard-card-header">
                <div>
                    <h3 class="dashboard-card-title">{% trans "Live Opportunities" %}</h3>
                    <div class="dashboard-card-value">{{ active_opportunities|default:"0" }}</div>
                    <div class="dashboard-card-change">{{ todays_opportunities|default:"0" }} {% trans "detected today" %}</div>
                </div>
                <div class="dashboard-card-icon">‚ö°</div>
            </div>
            <div class="dashboard-card-actions">
                <a href="{% url 'admin:arbitrage_arbitrageopportunity_changelist' %}" class="btn btn-white-outline">
                    {% trans "View All" %}
                </a>
            </div>
        </div>

        <!-- Exchange Status Card -->
        <div class="dashboard-card card-success">
            <div class="dashboard-card-header">
                <div>
                    <h3 class="dashboard-card-title">{% trans "Exchange Status" %}</h3>
                    <div class="dashboard-card-value">{{ online_exchanges|default:"0" }}/{{ total_exchanges|default:"0" }}</div>
                    <div class="dashboard-card-change">{% trans "exchanges online" %}</div>
                </div>
                <div class="dashboard-card-icon">üîó</div>
            </div>
            <div class="dashboard-card-actions">
                <a href="{% url 'admin:core_exchange_changelist' %}" class="btn btn-white-outline">
                    {% trans "Manage" %}
                </a>
            </div>
        </div>

        <!-- Profit Summary Card -->
        <div class="dashboard-card card-info">
            <div class="dashboard-card-header">
                <div>
                    <h3 class="dashboard-card-title">{% trans "Weekly Profit" %}</h3>
                    <div class="dashboard-card-value">${{ weekly_profit|floatformat:2|default:"0.00" }}</div>
                    <div class="dashboard-card-change">{{ success_rate|floatformat:1|default:"0.0" }}% {% trans "success rate" %}</div>
                </div>
                <div class="dashboard-card-icon">üí∞</div>
            </div>
            <div class="dashboard-card-actions">
                <a href="{% url 'admin:arbitrage_arbitrageexecution_changelist' %}" class="btn btn-white-outline">
                    {% trans "View Executions" %}
                </a>
            </div>
        </div>

        <!-- System Performance Card -->
        <div class="dashboard-card card-warning">
            <div class="dashboard-card-header">
                <div>
                    <h3 class="dashboard-card-title">{% trans "System Health" %}</h3>
                    <div class="dashboard-card-value">{{ avg_response_time|floatformat:0|default:"0" }}ms</div>
                    <div class="dashboard-card-change">{% trans "average response time" %}</div>
                </div>
                <div class="dashboard-card-icon">üìä</div>
            </div>
            <div class="dashboard-card-actions">
                <a href="{% url 'admin:analytics_exchangeperformance_changelist' %}" class="btn btn-white-outline">
                    {% trans "Performance" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>{% trans "Profit Trend (Last 7 Days)" %}</h3>
            <canvas id="profitChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>{% trans "Exchange Performance" %}</h3>
            <canvas id="exchangeChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Recent Activity Table -->
    <div class="recent-activity">
        <h3>{% trans "Recent Arbitrage Opportunities" %}</h3>
        <div class="activity-table">
            <table class="table">
                <thead>
                    <tr>
                        <th>{% trans "Trading Pair" %}</th>
                        <th>{% trans "Route" %}</th>
                        <th>{% trans "Profit" %}</th>
                        <th>{% trans "Status" %}</th>
                        <th>{% trans "Time" %}</th>
                    </tr>
                </thead>
                <tbody id="recent-opportunities">
                    {% for opportunity in recent_opportunities %}
                    <tr class="opportunity-row opportunity-{{ opportunity.profit_class }}">
                        <td>
                            <span class="trading-pair-symbol">{{ opportunity.trading_pair.symbol }}</span>
                        </td>
                        <td>
                            {{ opportunity.buy_exchange.name }} ‚Üí {{ opportunity.sell_exchange.name }}
                        </td>
                        <td>
                            <span class="profit-indicator profit-positive">
                                {{ opportunity.net_profit_percentage|floatformat:2 }}%
                            </span>
                        </td>
                        <td>
                            <span class="status-indicator status-{{ opportunity.status }}">
                                {{ opportunity.get_status_display }}
                            </span>
                        </td>
                        <td>{{ opportunity.created_at|timesince }} {% trans "ago" %}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-gray-500">
                            {% trans "No recent opportunities found" %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="dashboard-actions">
        <a href="{% url 'admin:arbitrage_arbitrageopportunity_add' %}" class="btn btn-primary">
            ‚ö° {% trans "Manual Scan" %}
        </a>
        <a href="{% url 'admin:arbitrage_arbitrageconfig_changelist' %}" class="btn btn-secondary">
            ‚öôÔ∏è {% trans "Configuration" %}
        </a>
        <a href="{% url 'admin:analytics_dailyarbitragesummary_changelist' %}" class="btn btn-secondary">
            üìä {% trans "Analytics" %}
        </a>
        <a href="{% url 'admin:trading_order_changelist' %}" class="btn btn-secondary">
            üìà {% trans "Trading" %}
        </a>
    </div>
</div>

<!-- Safely inject chart data as JSON -->
{{ profit_chart_labels|json_script:"profit-chart-labels" }}
{{ profit_chart_data|json_script:"profit-chart-data" }}
{{ exchange_chart_labels|json_script:"exchange-chart-labels" }}
{{ exchange_chart_data|json_script:"exchange-chart-data" }}

<script>
// Real-time dashboard updates
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initializeProfitChart();
    initializeExchangeChart();
    
    // Set up real-time updates
    setInterval(updateDashboard, 30000); // Update every 30 seconds
});

function initializeProfitChart() {
    const ctx = document.getElementById('profitChart').getContext('2d');
    const profitChartLabels = JSON.parse(document.getElementById('profit-chart-labels').textContent);
    const profitChartData = JSON.parse(document.getElementById('profit-chart-data').textContent);
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: profitChartLabels,
            datasets: [{
                label: '{% trans "Daily Profit" %}',
                data: profitChartData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function initializeExchangeChart() {
    const ctx = document.getElementById('exchangeChart').getContext('2d');
    const exchangeChartLabels = JSON.parse(document.getElementById('exchange-chart-labels').textContent);
    const exchangeChartData = JSON.parse(document.getElementById('exchange-chart-data').textContent);
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: exchangeChartLabels,
            datasets: [{
                data: exchangeChartData,
                backgroundColor: [
                    '#10b981',
                    '#f59e0b',
                    '#ef4444',
                    '#6366f1',
                    '#8b5cf6'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function updateDashboard() {
    // Update stats via AJAX
    fetch('/admin/api/dashboard-stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('active-opportunities').textContent = data.active_opportunities;
            document.getElementById('weekly-profit').textContent = '$' + data.weekly_profit.toFixed(2);
            document.getElementById('active-orders').textContent = data.active_orders;
        })
        .catch(error => console.error('Error updating dashboard:', error));
}
</script>
{% endblock %}

{% block sidebar %}
{{ block.super }}
{% endblock %}